<!DOCTYPE html>
<html lang="en">
	<head>
		<title>AP3.0 Engine Demo</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link href="css/main.css" rel="stylesheet" />

		<script src="../libs/Detector.js"></script>
		<script src="../libs/stats.min.js"></script>
		<script src="../libs/signals.min.js"></script>
		<script src="../libs/dat.gui.min.js"></script>

		<script src="../libs/three/three.min.js"></script>
		<script src="../libs/three/controls/TrackballControls.js"></script>

		<script src="js/audiopixel.js"></script>
		<script src="js/utils.js"></script>
		<script src="js/managers/AppManager.js"></script>
		<script src="js/managers/PortManager.js"></script>
		<script src="js/managers/HardwareManager.js"></script>
		<script src="js/managers/ChannelManager.js"></script>
		<script src="js/objects/Port.js"></script>
		<script src="js/objects/Channel.js"></script>
		<script src="js/objects/Pod.js"></script>
		<script src="js/objects/Clip.js"></script>
		<script src="js/objects/Shader.js"></script>
		<script src="js/objects/PodPosition.js"></script>
		<script src="js/shaders/core/ShaderUtils.js"></script>
		<script src="js/shaders/core/SimpleTextureShader.js"></script>
		<script src="js/shaders/core/NodeShader.js"></script>
		<script src="js/shaders/clips/BareBonesClip.js"></script>
		<script src="js/shaders/clips/BasicClip.js"></script>
		<script src="js/shaders/clips/BasicHsvClip.js"></script>
		<script src="js/shaders/clips/BasicFxClip.js"></script>
		<script src="js/shaders/clips/GreyscaleFx.js"></script>

		<script src="import/nodes/test.js"></script>
	</head>

	<body ontouchstart="" onload="onLoad()">

		<div id="container"></div>

		<script>


		if ( ! Detector.webgl ) { Detector.addGetWebGLMessage(); }


		var frameCount = 0;
		var gui = new dat.GUI();



		function onLoad(){


			// Register all clips by their id's for easy lookup later
			for (var property in ap.clips) {
				if (ap.clips.hasOwnProperty(property)) {
					ap.register[ap.clips[property].id] = property;
				}
			}


			// ****** Managers ******

			ap.ports = new PortManager();
			ap.hardware = new HardwareManager();
			ap.channels = new ChannelManager();
			ap.app = new AppManager(document.getElementById( 'container' ));
			ap.app.setSize(window.innerWidth, window.innerHeight);

			ap.ports.init();
			ap.hardware.init();
			ap.channels.init();
			ap.app.init();



			// -------Temporary: Create some Channels/Pods/Clips for testing----------

			var mix = 1;

			// Let's create some test clips for now (TODO: this should be loaded from current project settings or channel preset)

			//var clips = [new Clip(2, mix, ap.BLEND.Add), new Clip(4, mix, ap.BLEND.Add)];

			var pods = [new Pod(1, mix, ap.BLEND.Add, [new Clip(2, mix, ap.BLEND.Add)]), new Pod(2, mix, ap.BLEND.Add, [new Clip(1, mix, ap.BLEND.Add)])];
			//var pods = [new Pod(1, mix, ap.BLEND.Add, [new Clip(2, mix, ap.BLEND.Add)]), new Pod(1, mix, ap.BLEND.Add, [new Clip(1, mix, ap.BLEND.Add)]), new Pod(2, mix, ap.BLEND.Add, [new Clip(4, mix, ap.BLEND.Add), new Clip(5, mix, ap.BLEND.Add)])];
			//var pods2 = [new Pod(2, mix, ap.BLEND.Add, [new Clip(4, mix, ap.BLEND.Fx), new Clip(5, mix, ap.BLEND.Fx)])];
			
			
			// Let's create some test channels for now (TODO: this should be loaded from current project settings)
			ap.channels.channels[0] = new Channel("TestChannel1", ap.CHANNEL_TYPE_BLEND, mix, ap.BLEND.Add, pods);
			//ap.channels.channels[1] = new Channel("TestChannel2", ap.CHANNEL_TYPE_FX, mix, ap.BLEND.Fx, pods2);

			ap.app.updateNodePoints();
			ap.app.updateMainSourceShader();



			// ****** Runtime Loop ****** 

			var updateShader;
			var updateShaderLimiter = 10;
			// Allow limiter to be modified based on system capabilities, if we detect lag we can increase it

			function animate() {

				//if(frameCount % 30 == 1){ // Slow framerate testing


				// Update everything else if we don't have to update the shader this frame
				if(!updateShader || frameCount % updateShaderLimiter != 1){

					// ** Main loop update 
					ap.app.update();
					ap.ports.update();
					ap.hardware.update();
					ap.channels.update();

				}else{

					// We detected the shader needs an update, only do that this frame
					ap.app.updateMainSourceShader();
					ap.app.update();
					updateShader = false;
				}


				// Render next frame // TODO: throttle logic if needed
				requestAnimationFrame( animate );
				frameCount++;
			}

			animate();

			// ****** UI ******

			// TODO replace dat.gui with react components (or similar) that reflect model: ap.channels 

			var f1 = gui.addFolder('Channel 1'); 		f1.open();
			var guiData  = {
				Channel1Mix:  1,
				Pod1Mix:  1,
				Pod2Mix:  1,
				Shader1Mix:  1,
				Shader2Mix:  1,

				Channe2_1Mix:  1,
				Pod2_1Mix:  1,
				Pod2_2Mix:  1,
				Shader2_1Mix:  1,
				Shader2_2Mix:  1
			}
			f1.add( guiData, "Channel1Mix", 0.0, 1.0, 1.0 )		.onChange(function () { ap.app.material.uniforms._1_mix.value = guiData.Channel1Mix; });
			//f1.add( guiData, "Pod1Mix", 0.0, 1.0, 1.0 )			.onChange(function () { ap.app.material.uniforms._1_1_mix.value = guiData.Pod1Mix; });
			f1.add( guiData, "Shader1Mix", 0.0, 1.0, 1.0 )		.onChange(function () { ap.app.material.uniforms._1_1_1_mix.value = guiData.Shader1Mix; });
			f1.add( guiData, "Shader2_1Mix", 0.0, 1.0, 1.0 )	.onChange(function () { ap.app.material.uniforms._1_2_mix.value = guiData.Shader2_1Mix; });
			//f1.add( guiData, "Pod2Mix", 0.0, 1.0, 1.0 )			.onChange(function () { ap.app.material.uniforms._1_2_1_mix.value = guiData.Pod2Mix; });
			//f1.add( guiData, "Shader2Mix", 0.0, 1.0, 1.0 )		.onChange(function () { ap.app.material.uniforms._1_3_2_mix.value = guiData.Shader2Mix; });

			//f1.add( guiData, "Channe2_1Mix", 0.0, 1.0, 1.0 )	.onChange(function () { ap.app.material.uniforms._2_mix.value = guiData.Channe2_1Mix; });
			//f1.add( guiData, "Pod2_1Mix", 0.0, 1.0, 1.0 )		.onChange(function () { ap.app.material.uniforms._2_1_1_mix.value = guiData.Pod2_1Mix; });
			//f1.add( guiData, "Pod2_2Mix", 0.0, 1.0, 1.0 )		.onChange(function () { ap.app.material.uniforms._2_1_2_mix.value = guiData.Pod2_2Mix; });
			//f1.add( guiData, "Shader2_2Mix", 0.0, 1.0, 1.0 )	.onChange(function () { ap.app.material.uniforms._1_1_1_p1.value = guiData.Shader2_2Mix; });




			// ****** Event Handlers ****** 

			document.addEventListener( 'keydown', function ( event ) {

				//console.log(event.keyCode);

				switch ( event.keyCode ) {

					case 8: // prevent browser back
						event.preventDefault();
						break;


		// TESTING
		/*
					case 46: // delete

						ap.app.pointCloud.parent.remove( ap.app.pointCloud );

						console.log('delete');

						break;

					case 16: // shift

						ap.app.updateNodePoints(); // only need to call this when we add nodes after init
						ap.app.updateMainSourceShader();


						//ap.app.addPlanesForTesting(); 

						console.log("doitshift");

						break;
*/
					case 17: // ctrl
					
						updateShader = true;

						//ap.ports.clearAllPorts();
						
						var port3 = new Port("port name 03", ap.PORT_TYPE_KINET_1, "10.0.0.21");
						ap.ports.setPort(3, port3);
						ap.hardware.addTestGrid(3, 0, 880);

						var port3 = new Port("port name 04", ap.PORT_TYPE_KINET_1, "10.0.0.21");
						ap.ports.setPort(4, port3);
						ap.hardware.addTestGrid(4, 0, 1320);

						var port3 = new Port("port name 03", ap.PORT_TYPE_KINET_1, "10.0.0.21");
						ap.ports.setPort(5, port3);
						ap.hardware.addTestGrid(5, 800, 0);

						var port3 = new Port("port name 04", ap.PORT_TYPE_KINET_1, "10.0.0.21");
						ap.ports.setPort(6, port3);
						ap.hardware.addTestGrid(6, 800, 440);

						var port3 = new Port("port name 05", ap.PORT_TYPE_KINET_1, "10.0.0.21");
						ap.ports.setPort(7, port3);
						ap.hardware.addTestGrid(7, 800, 880);

						var port3 = new Port("port name 06", ap.PORT_TYPE_KINET_1, "10.0.0.21");
						ap.ports.setPort(8, port3);
						ap.hardware.addTestGrid(8, 800, 1320);
						
						ap.app.updateNodePoints(); // only need to call this when we add nodes after init
						ap.app.updateMainSourceShader();

						console.log("doit");

						break;
		
		
				}

			}, false );


			function onWindowResize() {

				// TODO - allow to be set in page and not always use fullscreen of window res
				ap.app.glWidth = window.innerWidth;
				ap.app.glHeight = window.innerHeight;

				if(ap.app.readPixels){
					ap.app.pixels = new Uint8Array(4 * ap.app.glWidth * ap.app.glHeight);
				}

				ap.app.camera.aspect = ap.app.glWidth / ap.app.glHeight;
				ap.app.camera.updateProjectionMatrix();

				ap.app.renderer.setSize( ap.app.glWidth, ap.app.glHeight );

			}

			window.addEventListener( 'resize', onWindowResize, false );

			setTimeout(onWindowResize, 1);

		}

		</script>
	</body>
</html>


<script id="fragment_shader_pass_1" type="x-shader/x-fragment">

//#INCLUDESHADERUTILS

precision mediump float;
float ap_index;
vec4 ap_xyz;
vec4 ap_xyz2;
//vec3  ap_lastRgb;
vec3 ap_rgb;
vec3 ap_hsv;
vec3 ap_rgb2;
vec4 ap_rgbV4;
vec3 ap_c;
vec3 ap_p;
vec3 ap_temp;
vec2 resolution;

varying vec2 v_vUv;
uniform float u_time;
//uniform float u_random;
uniform float u_mapSize;
uniform sampler2D u_coordsMap;
uniform sampler2D u_prevCMap;
//uniform sampler2D u_portsMap;

//#INCLUDESHADERFUNCTIONS


void main() {

	// Black is default
	ap_rgb = vec3(0.0);


	
	//********************************************
	
	ap_xyz = texture2D( u_coordsMap, v_vUv); // coordinates that get overwritten with each pod
	ap_xyz2 = ap_xyz; // coordinates that do not get overwritten (original)
	if(ap_xyz[3] == 0.0){ discard; }

	ap_index = ((1.0 - v_vUv.y) * u_mapSize * u_mapSize + v_vUv.x * u_mapSize);
	//ap_lastRgb = vec3(texture2D( u_prevCMap, v_vUv));

	vec2 p;

	//********************************************

	//#INCLUDESHADERS

	gl_FragColor = vec4(ap_c, 1.0);

}

</script>